{"globals":[{"key":"location","json":"\"39,-84.51\""},{"key":"email-1","json":"\"AEPMM.BWSC@state.ma.us\""},{"key":"email-2","json":"\"joe.molineaux@environmentalandenergy.com\""},{"key":"sms-1","json":"\"3392350280\""},{"key":"sendgridAPI","json":"\"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\""},{"key":"email-3","json":"\"zhirschtritt@gmail.com\""}],"triggers":[{"type":"integration","meta":{"category":"trigger","name":"particle","label":"Particle","x":20,"y":20,"uiId":"BkyvtoyS-","description":""},"config":{},"key":"596160ac502f3700079483b9","outputIds":[["H1VLas1rW"]]},{"type":"virtualButton","meta":{"category":"trigger","name":"virtualButton","label":"Try OFF 1","x":240,"y":20,"uiId":"SyM8SIRvUW","payload":"{ \"decoded\" : {\n  \"v\" : \"0\",\n  \"s\" : \"100\",\n \t\"n\" : \"electron-1\"\n},\n \"coreid\" : \"250028000351353337353037\"\n}","description":""},"config":{},"key":"591a1d27ddc0e90001281786-ByXIHU0w8","outputIds":[["B1Ir8Rv8-"]]},{"type":"virtualButton","meta":{"category":"trigger","name":"virtualButton","label":"Try ON 1","x":440,"y":20,"uiId":"Hye0k728b","payload":"{ \"decoded\" : {\n  \"v\" : \"1\",\n  \"s\" : \"100\"\n},\n \"coreid\" : \"250028000351353337353037\"\n}","description":""},"config":{},"key":"591a1d27ddc0e90001281786-BkglCkm2UW","outputIds":[["B1Ir8Rv8-"]]},{"type":"virtualButton","meta":{"category":"trigger","name":"virtualButton","label":"Toggle Email","x":720,"y":20,"uiId":"rkWFSXnIZ","payload":"","description":""},"config":{},"key":"591a1d27ddc0e90001281786-HyYeL73UZ","outputIds":[["ryv7vmhLb"]]},{"type":"virtualButton","meta":{"category":"trigger","name":"virtualButton","label":"Try ON 2","x":480,"y":160,"uiId":"rkKeBVT8-","payload":"{ \"decoded\" : {\n  \"v\" : \"1\",\n  \"s\" : \"100\",\n \t\"n\" : \"electron-2\"\n },\n \"coreid\" : \"4d002f001951353338363036\"\n}","description":""},"config":{},"key":"591a1d27ddc0e90001281786-ByeFgSEpU","outputIds":[["B1Ir8Rv8-"]]},{"type":"virtualButton","meta":{"category":"trigger","name":"virtualButton","label":"Try OFF 2","x":480,"y":240,"uiId":"ByaybwTU-","payload":"{ \"decoded\" : {\n  \"v\" : \"0\",\n  \"s\" : \"100\",\n \t\"n\" : \"electron-2\"\n },\n \"coreid\" : \"4d002f001951353338363036\"\n}","description":""},"config":{},"key":"591a1d27ddc0e90001281786-B1eakZPaUZ","outputIds":[["B1Ir8Rv8-"]]},{"config":{"seconds":7200},"outputIds":[["SyKZV0TgG"]],"key":"591a1b93ddc0e90001281785","type":"deviceIdInactivity","meta":{"category":"trigger","name":"deviceIdsTagsInactivity","label":"Device: Inactive","x":1000,"y":20,"uiId":"rJKpX0pgG","description":""}}],"nodes":[{"type":"DeviceChangeStateNode","meta":{"category":"output","name":"device-state","label":"Device State","x":180,"y":500,"description":""},"config":{"deviceIdTemplateType":"jsonPath","timeSourceType":"payloadTime","attrDataMethod":"individualFields","deviceId":"data.losantDeviceID.id","attrInfos":[{"key":"VFDState","valueTemplate":"{{data.decoded.v}}"},{"key":"batteryLevel","valueTemplate":"{{data.decoded.s}}"}]},"id":"B14OYjwxW","outputIds":[["Sky7Gkyrb","rkQ6FXh8Z"]]},{"type":"DebugNode","meta":{"category":"output","name":"debug","label":"Debug","x":80,"y":600,"description":""},"config":{"message":"","property":""},"id":"Sky7Gkyrb","outputIds":[]},{"type":"JsonDecodeNode","meta":{"category":"logic","name":"json-decode","label":"Decode JSON","x":20,"y":140,"description":""},"config":{"source":"data.data","destination":"data.decoded"},"id":"H1VLas1rW","outputIds":[["B1Ir8Rv8-"]]},{"type":"GetDeviceNode","meta":{"category":"data","name":"get-device","label":"Get Device","x":180,"y":420,"description":""},"config":{"findMethod":"tags","resultPath":"data.losantDeviceID","tagsAsObject":false,"findMultiple":false,"tags":[{"keyTemplate":"particle_coreid","valueTemplate":"{{data.coreid}}"}]},"id":"SJV7sXrLW","outputIds":[["B14OYjwxW"]]},{"type":"HttpNode","meta":{"category":"data","name":"http","label":"Call GoogleAPI","x":180,"y":260,"description":""},"config":{"method":"GET","uriTemplate":"https://maps.googleapis.com/maps/api/timezone/json?timestamp={{formatDate time 'X'}}&location={{globals.location}}","responsePath":"timeZoneResponse","disableSSLVerification":false,"headerInfo":[]},"id":"B1Ir8Rv8-","outputIds":[["ByxIH8ADU-"]]},{"type":"MutateNode","meta":{"category":"logic","name":"mutate","label":"Set Local Time","x":180,"y":340,"description":""},"config":{"rules":[{"type":"set","destination":"timeOffset","valueTemplate":"{{add timeZoneResponse.body.dstOffset timeZoneResponse.body.rawOffset}}"},{"type":"set","destination":"localTimeSeconds","valueTemplate":"{{add (formatDate time 'X') timeOffset}}"},{"type":"set","destination":"localTimeFormatted","valueTemplate":"{{formatDate (multiply localTimeSeconds 1000)}}"},{"type":"set","destination":"localTimeFormattedDate","valueTemplate":"{{formatDate (multiply localTimeSeconds 1000) 'YYYYMMDD'}}"},{"type":"set","destination":"localTimeFormattedTime","valueTemplate":"{{formatDate (multiply localTimeSeconds 1000) 'kk:mm'}}"}]},"id":"ByxIH8ADU-","outputIds":[["SJV7sXrLW"]]},{"type":"BranchOnChangeNode","meta":{"category":"logic","name":"onchange","label":"On Change","x":380,"y":680,"description":""},"config":{"valuePath":"data.decoded.v","changeType":"any","prevValuePath":"","onChangeIdTemplate":"{{data.coreid}}","changeThreshold":null},"id":"SJe2wW3Ub","outputIds":[[],["H1Lqvw68-"]]},{"type":"RecordEventNode","meta":{"category":"output","name":"event","label":"Record Restart","x":660,"y":920,"levelType":"info","description":""},"config":{"messageTemplate":"Device {{data.losantDeviceID.name}} restarted. ","subjectTemplate":"{{data.losantDeviceID.name}} Restart","eventIdPath":"","eventDataPath":"data.eventData","level":"info"},"id":"rJrmdZhIb","outputIds":[["Hyb43AJDb"]]},{"type":"DebugNode","meta":{"category":"output","name":"debug","label":"Debug","x":720,"y":360,"description":""},"config":{"message":"","property":""},"id":"HyTk8mhUb","outputIds":[]},{"type":"DeviceChangeStateNode","meta":{"category":"output","name":"device-state","label":"Device State","x":720,"y":280,"description":""},"config":{"deviceIdTemplateType":"jsonPath","timeSourceType":"payloadTime","attrDataMethod":"individualFields","deviceId":"deviceData.id","attrInfos":[{"key":"emailState","valueTemplate":"{{data.emailState}}"}]},"id":"SJ6587hL-","outputIds":[["HyTk8mhUb"]]},{"type":"GetDeviceNode","meta":{"category":"data","name":"get-device","label":"Get Device","x":720,"y":120,"description":""},"config":{"findMethod":"tags","resultPath":"deviceData","tagsAsObject":false,"findMultiple":false,"tags":[{"keyTemplate":"particle_coreid","valueTemplate":"{{data.coreid}}"}]},"id":"ryv7vmhLb","outputIds":[["r1P4JgePb"]]},{"type":"ConditionalNode","meta":{"category":"logic","name":"conditional","label":"Condtional","x":380,"y":600,"description":"If there is data for VFD, continue"},"config":{"expression":"{{data.decoded.v}} != null"},"id":"rkQ6FXh8Z","outputIds":[[],["SJe2wW3Ub"]]},{"type":"ConditionalNode","meta":{"category":"logic","name":"conditional","label":"VFD State","x":520,"y":800,"description":"Is this a \"restart\" or \"shutdown\" event?"},"config":{"expression":"{{data.decoded.v}} == 1"},"id":"H1Lqvw68-","outputIds":[["ryVytD68Z"],["rJrmdZhIb"]]},{"type":"RecordEventNode","meta":{"category":"output","name":"event","label":"Record Shutdown","x":400,"y":920,"levelType":"warning","description":""},"config":{"messageTemplate":"Device {{data.losantDeviceID.name}} shutdown. Email sent? YES/NO","subjectTemplate":"{{data.losantDeviceID.name}} Shutdown","eventIdPath":"","eventDataPath":"data.eventData","level":"warning"},"id":"ryVytD68Z","outputIds":[["Hyb43AJDb"]]},{"type":"ConditionalNode","meta":{"category":"logic","name":"conditional","label":"Email State","x":540,"y":1160,"description":""},"config":{"expression":"{{deviceEmailState.value}} == 1"},"id":"BJhoO0ywW","outputIds":[[],["S1Zjs0Jwb"]]},{"type":"RawFunctionNode","meta":{"category":"logic","name":"function","label":"Format Email","x":640,"y":1260,"description":""},"config":{"script":"var emailCSV = \"NA\"\nvar RTNnum = \"NA\"\nvar RTNdeviceNumber = \"NA\"\nvar state = \"NA\"\n\nRTNnum = payload.data.losantDeviceID.tags[3].value;\nRTNdeviceNumber = payload.data.losantDeviceID.tags[4].value;\n\nif (payload.data.decoded.v == \"0\") {\n  state = \"shutdown\"\n} else {\n  state = \"restart\"\n}\n\npayload.emailCSV = '\"' + RTNnum + '\",' \n\t\t\t\t\t\t\t\t\t+ '\"' + RTNdeviceNumber + '\",' \n  \t\t\t\t\t\t\t\t+ '\"' + state + '\",' \n  \t\t\t\t\t\t\t\t+ '\"' + payload.localTimeFormattedDate + '\",'\n\t\t\t\t\t\t\t\t\t+ '\"' + payload.localTimeFormattedTime + '\"'\n  \n"},"id":"S1Zjs0Jwb","outputIds":[["S1-AEhNtb"]]},{"type":"GaugeNode","meta":{"category":"data","name":"gauge","label":"Email State","x":540,"y":1060,"deviceSelectionType":"payload","customRange":false,"description":""},"config":{"resultPath":"deviceEmailState","attribute":"emailState","deviceIds":[],"deviceTags":[],"deviceIdsPath":"data.losantDeviceID.id","end":"","duration":"0","aggregation":"MAX"},"id":"Hyb43AJDb","outputIds":[["BJhoO0ywW"]]},{"type":"RawFunctionNode","meta":{"category":"logic","name":"function","label":"Convert Email State","x":720,"y":200,"description":""},"config":{"script":"if(payload.data.emailState == true) {\n  payload.data.emailState = 1\n}else{\n  payload.data.emailState = 0\n}"},"id":"r1P4JgePb","outputIds":[["SJ6587hL-"]]},{"type":"SendgridEmailNode","meta":{"category":"output","name":"sendgrid","label":"SendGrid","x":640,"y":1380,"description":""},"config":{"bodyTemplate":"{{emailCSV}}","subjectTemplate":"Notification","fromTemplate":"notifications@environmentalandenergy.com","replyToTemplate":"","sendgridApiKey":"{{globals.sendgridAPI}}","resultPath":"data.sendgridResult","toAddresses":["{{globals.email-1}}"],"ccAddresses":["{{globals.email-2}}","{{globals.email-3}}"],"bccAddresses":[]},"id":"S1-AEhNtb","outputIds":[["ry30434KW"]]},{"type":"DebugNode","meta":{"category":"output","name":"debug","label":"Debug","x":640,"y":1480,"description":""},"config":{"message":"","property":""},"id":"ry30434KW","outputIds":[]},{"type":"StructureEmailNode","meta":{"category":"output","name":"structure-email","label":"Email","x":1000,"y":120,"description":""},"config":{"bodyTemplate":"SSDS Monitor down for two hours! ","subjectTemplate":"SSDS Monitor Down","fromTemplate":"SSDSMonitor@losant.com","toAddresses":["zhirschtritt@gmail.com"]},"id":"SyKZV0TgG","outputIds":[["3pYI7oIU0h"]]},{"type":"DebugNode","meta":{"category":"output","name":"debug","label":"Debug","x":1000,"y":220,"description":""},"config":{"message":"","property":""},"id":"3pYI7oIU0h","outputIds":[]}],"name":"Particle Electron SSDS Monitor","enabled":true,"description":"","applicationId":"58320d2d29c5da01009e62f4","_type":"flow","_exportDate":"2017-12-20T18:02:13.626Z"}